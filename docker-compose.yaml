services:

  doc-search-service:
    container_name: doc-search-service_opensource
    build:
      context: ./Doc-search-service/file-search-api
      dockerfile: doc-api.Dockerfile
    
    user: root

    ports:
      - 4455:4444
    
    volumes:
      - ./ameya-inverted-index:/app/ameya-inverted-index
      - ./Doc-search-service/file-search-api/temp:/app/temp
      
    
    networks:
      - app_network

    env_file:
      - ./.env

    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '1.0'
          memory: 1G
          
    restart: on-failure

    command: "uvicorn main.api:app --host 0.0.0.0 --port 4444 --reload"

  rabbitmq_pdf_parser_dev:
    image: rabbitmq:3.12.1-management
    container_name: file_search_rabbitmq
    restart: always
    ports:
      - "5679:5672"
      - "15769:15672"

    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

    networks:
      - app_network


  redis_service:
    image: redis:alpine
    container_name: file_search_redis

    ports:
      - 6382:6379

    networks:
      - app_network
    command: redis-server --appendonly yes
    restart: always


  docsearch_consumer_opensource:
    build:
        context: ./Doc-search-service/file-search-consumer
        dockerfile: consumer.Dockerfile
    user: root
    container_name: docsearch_consumer_opensource
    deploy:
      resources:
        limits:
          cpus: '5.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    
    volumes:
      - ./ameya-inverted-index:/app/ameya-inverted-index
      - ./Doc-search-service/temp:/app/temp

    env_file:
      - ./.env
    command: sh -c 'sleep 2 && export PYTHONPATH="`pwd`" && python3 /app/event_driven/consumer.py'
    
    networks:
      - app_network

volumes:
  rabbitmq_data:
    driver: local
  
  redis_data:
    driver: local


networks:
    prod_audit_network:
        external: true
    app_network:
        external: true